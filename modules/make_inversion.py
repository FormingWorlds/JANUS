import numpy as np
import matplotlib.pyplot as plt

def inversion(T_day, Ts_day, Ts_night, p_day, p_night, surf_inv):
    """Change a profile to introduce an inversion below an arbitrary pressure

    Parameters
    ----------
        T_day : array of floats
            dayside temperature array
        Ts_day : float
            dayside surface temperature 
        Ts_night : float
            nightside surface temperature 
        p_day : array of floats
            dayside pressure array
        p_night : array of floats
            nightside pressure array
        surf_inv : logical
            Flag to trigger the inversion to be at the bottom layer
    """

    if surf_inv:
        p_inv = 1e5
    else:
        p_inv = 1e4 # initialize the index where dayside and nightside join profiles. 1e4 is high enough to start for the range 200-3000 K and 1-261 bar.

    p_day_inv_i = np.argmin(np.abs(p_day - p_inv))
    if Ts_day > Ts_night: # Only if the dayside is actually warmer
        while T_day[p_day_inv_i] <= Ts_night:                   # the point of inversion should end up smaller than the dayside surface temperature but greater than the starting point. 
            p_day_inv_i += 1
    
    T_lower = T_day[p_day_inv_i]
    T_upper = T_day[-1]
    if surf_inv:
        T_inv   = T_upper   
    else:
        T_inv   = (T_upper + T_lower) / 2.3                 # choose a position in-between the two, totally arbitrary.
    p_inv = p_day[np.argmin(np.abs(T_day - T_inv))]

    ps_index_night = np.argmin(np.abs(p_day - p_night[-1])) # index of ps_night in p_day
    T_night = np.interp(p_night, p_day[:ps_index_night], T_day[:ps_index_night])  # Find T_night as the interpolation of T_day onto p_night
    p_night_inv_i = np.argmin(np.abs(p_night - p_inv))
    # Update T_night values past p_index_night if Ts_night is strictly smaller than T_day at the same pressure  
    if nightside_surface_temp < T_day[ps_index_night]:
        T_night[p_night_inv_i:] = np.linspace(T_night[p_night_inv_i], Ts_night, len(T_night) - p_night_inv_i)
        T_night[-1] = Ts_night

    return T_night


T_surf = 400

if T_surf == 650:
    pressure_array_day =  np.array([1.09033831e+00, 1.29341761e+00, 1.53432114e+00, 1.82009378e+00,
    2.15909257e+00, 2.56123107e+00, 3.03826925e+00, 3.60415746e+00,
    4.27544431e+00, 5.07176066e+00, 6.01639371e+00, 7.13696794e+00,
    8.46625302e+00, 1.00431221e+01, 1.19136884e+01, 1.41326543e+01,
    1.67649103e+01, 1.98874331e+01, 2.35915366e+01, 2.79855422e+01,
    3.31979467e+01, 3.93811797e+01, 4.67160612e+01, 5.54170899e+01,
    6.57387155e+01, 7.79827796e+01, 9.25073433e+01, 1.09737157e+02,
    1.30176084e+02, 1.54421832e+02, 1.83183435e+02, 2.17301986e+02,
    2.57775236e+02, 3.05786770e+02, 3.62740618e+02, 4.30302319e+02,
    5.10447621e+02, 6.05520264e+02, 7.18300517e+02, 8.52086484e+02,
    1.01079055e+03, 1.19905380e+03, 1.42238174e+03, 1.68730528e+03,
    2.00157175e+03, 2.37437145e+03, 2.81660638e+03, 3.34120911e+03,
    3.96352091e+03, 4.70174045e+03, 5.57745595e+03, 6.61627650e+03,
    7.84858099e+03, 9.31040647e+03, 1.10445020e+04, 1.31015789e+04,
    1.55417935e+04, 1.84365065e+04, 2.18703699e+04, 2.59438023e+04,
    3.07759256e+04, 3.65080487e+04, 4.33077997e+04, 5.13740278e+04,
    6.09426190e+04, 7.22933935e+04, 8.57582893e+04, 1.01731069e+05,
    1.20678834e+05, 1.43155686e+05, 1.69818930e+05, 2.01448295e+05,
    2.38968740e+05, 2.83477498e+05, 3.36276167e+05, 3.98908772e+05,
    4.73206917e+05, 5.61343349e+05, 6.65895499e+05, 7.89920849e+05,
    9.37046352e+05, 1.11157449e+06, 1.31860910e+06, 1.56420463e+06,
    1.85554318e+06, 2.20114454e+06, 2.61111536e+06, 3.09744467e+06,
    3.67435450e+06, 4.35871579e+06, 5.17054175e+06, 6.13357312e+06,
    7.27597242e+06, 8.63114757e+06, 1.02387288e+07, 1.21457276e+07,
    1.44079116e+07, 1.70914352e+07, 2.02747743e+07, 2.40510215e+07])

    pressure_array_night = np.array([1.07581157e+00, 1.24355639e+00, 1.43745664e+00, 1.66159059e+00,
    1.92067239e+00, 2.22015126e+00, 2.56632606e+00, 2.96647781e+00,
    3.42902282e+00, 3.96368967e+00, 4.58172391e+00, 5.29612450e+00,
    6.12191727e+00, 7.07647093e+00, 8.17986239e+00, 9.45529902e+00,
    1.09296068e+01, 1.26337945e+01, 1.46037059e+01, 1.68807738e+01,
    1.95128911e+01, 2.25554185e+01, 2.60723490e+01, 3.01376532e+01,
    3.48368358e+01, 4.02687336e+01, 4.65475945e+01, 5.38054804e+01,
    6.21950446e+01, 7.18927430e+01, 8.31025450e+01, 9.60602239e+01,
    1.11038316e+02, 1.28351851e+02, 1.48364981e+02, 1.71498638e+02,
    1.98239387e+02, 2.29149660e+02, 2.64879585e+02, 3.06180662e+02,
    3.53921567e+02, 4.09106424e+02, 4.72895923e+02, 5.46631733e+02,
    6.31864724e+02, 7.30387582e+02, 8.44272515e+02, 9.75914839e+02,
    1.12808336e+03, 1.30397860e+03, 1.50730012e+03, 1.74232434e+03,
    2.01399447e+03, 2.32802449e+03, 2.69101931e+03, 3.11061373e+03,
    3.59563298e+03, 4.15627836e+03, 4.80434179e+03, 5.55345384e+03,
    6.41937043e+03, 7.42030416e+03, 8.57730746e+03, 9.91471531e+03,
    1.14606571e+04, 1.32476483e+04, 1.53132742e+04, 1.77009808e+04,
    2.04609880e+04, 2.36513465e+04, 2.73391584e+04, 3.16019886e+04,
    3.65294962e+04, 4.22253203e+04, 4.88092600e+04, 5.64197937e+04,
    6.52169920e+04, 7.53858844e+04, 8.71403510e+04, 1.00727621e+05,
    1.16433471e+05, 1.34588241e+05, 1.55573774e+05, 1.79831455e+05,
    2.07871489e+05, 2.40283638e+05, 2.77749617e+05, 3.21057440e+05,
    3.71117992e+05, 4.28984183e+05, 4.95873101e+05, 5.73191604e+05,
    6.62565916e+05, 7.65875825e+05, 8.85294226e+05, 1.02333282e+06,
    1.18289494e+06, 1.36733661e+06, 1.58053717e+06, 1.82698080e+06])

    dayside_temperature = np.array([213.10445887, 214.37385544, 215.65847001, 216.9585779,  218.27446108,
    219.60640843, 220.95471593, 222.31968685, 223.70163202, 225.10087004,
    226.51772756, 227.95253947, 229.40563328, 230.8773447 , 232.36805022,
    233.87813628, 235.40798331, 236.95798175, 238.5285324 , 240.12004673,
    241.73294731, 243.36766812, 245.02465495, 246.70436586, 248.40727151,
    250.13381801, 251.88450165, 253.65987035, 255.46044993, 257.2867812,
    259.13942061, 261.01894071, 262.92593081, 264.86099755, 266.82476561,
    268.81787828, 270.84099826, 272.94754212, 275.23387632, 277.65291981,
    280.11487108, 282.62088194, 285.1721458 , 287.76989956, 290.4154256,
    293.11005392, 295.85516424, 298.6521884 , 301.50261299, 304.40798199,
    307.36983681, 310.3898422 , 313.46979162, 316.6114876 , 319.81680565,
    323.08769806, 326.42619783, 329.83442288, 333.3145805 , 336.86897211,
    340.49999834, 344.21016448, 348.00204676, 351.87833543, 355.84192186,
    359.89582984, 364.04318208, 368.28724698, 372.63144713, 377.07936842,
    381.63476997, 386.30159483, 391.08398138, 395.98627537, 401.01304301,
    406.16898026, 411.45913341, 416.88891998, 422.46394137, 428.19010278,
    434.07363404, 440.12111151, 446.33948307, 452.7360952 , 459.31872078,
    466.09559095, 473.07543021, 480.26742097, 487.6813103 , 495.32760155,
    503.21746626, 511.36272492, 519.77597348, 528.47064743, 537.46109396,
    546.76264577, 561.63907368, 584.26780161, 609.77853891, 636.40322164])

    nightside_temperature = np.array([212.37100231, 213.44254947, 214.52496582, 215.61841207, 216.72306329,
    217.83908687, 218.96666518, 220.10597262, 221.25719926, 222.42052689,
    223.59615367, 224.78426919, 225.98508014, 227.19878432, 228.42559742,
    229.66572589, 230.91939493, 232.18682011, 233.46823665, 234.7638698,
    236.07396533, 237.3987587 , 238.73850687, 240.09345608, 241.4638751,
    242.85002161, 244.25217686, 245.67061063, 247.10561742, 248.55747979,
    250.02650628, 251.51299303, 253.01726343, 254.53962805, 256.08042603,
    257.63998325, 259.21865559, 260.81678517, 262.43474566, 264.07289646,
    265.73163014, 267.4113245 , 269.11239221, 270.83523067, 272.60481373,
    274.5224109 , 276.56748064, 278.64323519, 280.75038753, 282.88963777,
    285.06173621, 287.26744054, 289.50753448, 291.78283798, 294.09417793,
    296.44242729, 298.8284668 , 301.25322676, 303.71764623, 306.22271762,
    308.76944321, 311.35888282, 313.99210735, 316.67024983, 319.39445579,
    322.16593788, 324.98592288, 327.85571016, 330.7766151 , 333.75003168,
    336.77737203, 339.86013351, 342.99983403, 346.1980841 , 349.45651757,
    352.77686891, 356.16089919, 359.61047904, 363.12750939, 366.71401061,
    370.37203767, 374.10377596, 377.91145041, 381.79742864, 385.76412347,
    389.81410412, 393.9499916 , 398.1745786 , 402.49071729, 406.90144866,
    411.40988208, 416.01933506, 420.73320383, 425.55511453, 430.48878413,
    435.53818413, 440.70739101, 446.00076372, 451.42278277, 456.97824296])

    nightside_surface_temp = 459.7901265487135

elif T_surf == 400:
    pressure_array_day =  np.array([1.06045869e+00, 1.20719749e+00, 1.37424095e+00, 1.56439872e+00,
    1.78086917e+00, 2.02729328e+00, 2.30781582e+00, 2.62715509e+00,
    2.99068227e+00, 3.40451178e+00, 3.87560409e+00, 4.41188284e+00,
    5.02236805e+00, 5.71732790e+00, 6.50845138e+00, 7.40904496e+00,
    8.43425631e+00, 9.60132918e+00, 1.09298934e+01, 1.24422949e+01,
    1.41639718e+01, 1.61238823e+01, 1.83549913e+01, 2.08948255e+01,
    2.37861040e+01, 2.70774572e+01, 3.08242447e+01, 3.50894861e+01,
    3.99449216e+01, 4.54722180e+01, 5.17643426e+01, 5.89271270e+01,
    6.70810470e+01, 7.63632489e+01, 8.69298564e+01, 9.89585965e+01,
    1.12651789e+02, 1.28239748e+02, 1.45984660e+02, 1.66184987e+02,
    1.89180492e+02, 2.15357954e+02, 2.45157668e+02, 2.79080856e+02,
    3.17698095e+02, 3.61658916e+02, 4.11702724e+02, 4.68671242e+02,
    5.33522661e+02, 6.07347761e+02, 6.91388259e+02, 7.87057687e+02,
    8.95965175e+02, 1.01994251e+03, 1.16107496e+03, 1.32173632e+03,
    1.50462886e+03, 1.71282879e+03, 1.94983795e+03, 2.21964277e+03,
    2.52678127e+03, 2.87641943e+03, 3.27443805e+03, 3.72753168e+03,
    4.24332121e+03, 4.83048205e+03, 5.49889007e+03, 6.25978767e+03,
    7.12597292e+03, 8.11201476e+03, 9.23449812e+03, 1.05123028e+04,
    1.19669211e+04, 1.36228192e+04, 1.55078487e+04, 1.76537154e+04,
    2.00965120e+04, 2.28773255e+04, 2.60429283e+04, 2.96465650e+04,
    3.37488474e+04, 3.84187748e+04, 4.37348937e+04, 4.97866197e+04,
    5.66757407e+04, 6.45181298e+04, 7.34456933e+04, 8.36085900e+04,
    9.51777567e+04, 1.08347783e+05, 1.23340185e+05, 1.40407129e+05,
    1.59835677e+05, 1.81952610e+05, 2.07129928e+05, 2.35791105e+05,
    2.68418215e+05, 3.05560033e+05, 3.47841274e+05, 3.95973095e+05])

    pressure_array_night =  np.array([1.05576299e+00, 1.18478784e+00, 1.32958082e+00, 1.49206895e+00,
    1.67441478e+00, 1.87904509e+00, 2.10868328e+00, 2.36638557e+00,
    2.65558167e+00, 2.98012044e+00, 3.34432111e+00, 3.75303076e+00,
    4.21168884e+00, 4.72639954e+00, 5.30401307e+00, 5.95221677e+00,
    6.67963748e+00, 7.49595631e+00, 8.41203751e+00, 9.44007303e+00,
    1.05937448e+01, 1.18884069e+01, 1.33412897e+01, 1.49717294e+01,
    1.68014252e+01, 1.88547282e+01, 2.11589655e+01, 2.37448037e+01,
    2.66466574e+01, 2.99031467e+01, 3.35576118e+01, 3.76586892e+01,
    4.22609595e+01, 4.74256735e+01, 5.32215674e+01, 5.97257778e+01,
    6.70248681e+01, 7.52159806e+01, 8.44081294e+01, 9.47236511e+01,
    1.06299833e+02, 1.19290741e+02, 1.33869269e+02, 1.50229439e+02,
    1.68588986e+02, 1.89192254e+02, 2.12313449e+02, 2.38260287e+02,
    2.67378088e+02, 3.00054378e+02, 3.36724038e+02, 3.77875100e+02,
    4.24055235e+02, 4.75879046e+02, 5.34036248e+02, 5.99300845e+02,
    6.72541431e+02, 7.54732753e+02, 8.46968680e+02, 9.50476765e+02,
    1.06663458e+03, 1.19698804e+03, 1.34327201e+03, 1.50743335e+03,
    1.69165686e+03, 1.89839433e+03, 2.13039719e+03, 2.39075314e+03,
    2.68292720e+03, 3.01080787e+03, 3.37875885e+03, 3.79167714e+03,
    4.25505819e+03, 4.77506907e+03, 5.35863050e+03, 6.01350900e+03,
    6.74842023e+03, 7.57314501e+03, 8.49865944e+03, 9.53728103e+03,
    1.07028326e+04, 1.20108263e+04, 1.34786700e+04, 1.51258990e+04,
    1.69744358e+04, 1.90488825e+04, 2.13768474e+04, 2.39893130e+04,
    2.69210481e+04, 3.02110707e+04, 3.39031672e+04, 3.80464750e+04,
    4.26961366e+04, 4.79140336e+04, 5.37696100e+04, 6.03407967e+04,
    6.77150485e+04, 7.59905080e+04, 8.52773118e+04, 9.56990563e+04])

    dayside_temperature =  np.array([209.51038743, 210.45528016, 211.40870498, 212.37077817, 213.34161816,
    214.32134552, 215.31008306, 216.30795587, 217.31509134, 218.33161927,
    219.35767189, 220.39338391, 221.4388926 , 222.49433785, 223.55986222,
    224.63561102, 225.72173236, 226.81837722, 227.92569954, 229.04385627,
    230.17300746, 231.3133163 , 232.46494928, 233.62807616, 234.80287017,
    235.98949094, 237.18811843, 238.39895335, 239.62218341, 240.85800021,
    242.10659933, 243.36818042, 244.64294729, 245.93110808, 247.23287531,
    248.54846602, 249.87810192, 251.22200946, 252.58042   , 253.95356994,
    255.34170084, 256.74505957, 258.16389847, 259.59847547, 261.04905429,
    262.51590455, 263.99930201, 265.49952867, 267.01687298, 268.55163003,
    270.10407969, 271.67453042, 273.33065476, 275.12086815, 276.98110331,
    278.86662875, 280.77796459, 282.71564533, 284.68022034, 286.6722544,
    288.69232823, 290.74103907, 292.81900125, 294.92684634, 297.06522363,
    299.23480191, 301.43627032, 303.6703385 , 305.9377373 , 308.23921965,
    310.57556136, 312.947562  , 315.3560456 , 317.80186166, 320.28588656,
    322.80898984, 325.37210356, 327.97622445, 330.6223467 , 333.31149698,
    336.04473554, 338.82315779, 341.64789605, 344.52012099, 347.44104314,
    350.41191468, 353.43403116, 356.50873329, 359.63740906, 362.82149614,
    366.06248395, 369.36191592, 372.72139204, 376.14257127, 379.62717442,
    383.1769874 , 386.7938642 , 390.47973005, 394.23658493, 398.0665072 ])


    nightside_temperature =  np.array([ 36.65247652,  36.84209824,  37.03369445,  37.22729185,  37.42292635,
    37.62062578,  37.8204276 ,  38.02236084,  38.22646457,  38.43276909,
    38.64131517,  38.85213446,  39.06526952,  39.28075342,  39.49863061,
    39.71893567,  39.94171416,  40.167004  ,  40.39484745,  40.62529319,
    40.85838094,  41.09416164,  41.33267685,  41.57397992,  41.8181144,
    42.06513616,  42.31509085,  42.56803702,  42.82402257,  43.08310888,
    43.3453462 ,  43.61079897,  43.87951993,  44.1515746 ,  44.42702267,
    44.70592644,  44.98835742,  45.27437674,  45.56405958,  45.85747025,
    46.15468788,  46.45578018,  46.76083044,  47.54329204,  48.98036407,
    50.62369532,  52.32218072,  54.07763409,  55.89200588,  57.76723144,
    59.70537801,  61.70854781,  63.77891183,  65.91875548,  68.13037667,
    70.41621944,  72.77873568,  75.22053912,  77.7442459 ,  80.35265122,
    83.04854651,  85.834921  ,  88.71475316,  91.69123972,  94.76755872,
    97.94712878, 101.23334086, 104.62980745, 108.1402336 , 111.76841296,
    115.51835131, 119.39407478, 123.39986724, 127.54002461, 131.81912814,
    136.24176157, 140.81282415, 145.53720658, 150.42014763, 155.466864,
    160.6829531 , 166.07396679, 171.64585212, 177.40443087, 183.35571242,
    189.50548097, 195.85861067, 202.41813174, 209.18241421, 216.14089332,
    223.2656695 , 230.5006057 , 237.74983982, 244.87843082, 251.73421446,
    258.19039626, 264.17906253, 269.69721755, 275.03997187, 280.33599898])

    nightside_surface_temp = 282.9342648527568

nightside_temperature = inversion(dayside_temperature, T_surf, nightside_surface_temp, pressure_array_day, pressure_array_night, True)

plt.semilogy(dayside_temperature, pressure_array_day, marker='x', label='Dayside Temperature')
plt.semilogy(nightside_temperature, pressure_array_night, marker='x', label='Nightside Temperature')
plt.xlabel('Temperature')
plt.ylabel('Pressure')
plt.title('Dayside and Nightside Temperature Profiles')
plt.gca().invert_yaxis()
plt.legend()
plt.show()